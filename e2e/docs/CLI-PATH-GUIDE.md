# E2E æµ‹è¯• CLI è·¯å¾„é…ç½®æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•åœ¨ä¸åŒåœºæ™¯ä¸‹æŒ‡å®š CLI è·¯å¾„è¿›è¡Œ E2E æµ‹è¯•ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- âœ… **çµæ´»çš„è·¯å¾„é…ç½®** - æ”¯æŒå‘½ä»¤è¡Œå‚æ•°æŒ‡å®š CLI è·¯å¾„
- âœ… **å¤šç§æµ‹è¯•åœºæ™¯** - å¼€å‘ã€æ„å»ºã€å‘å¸ƒåŒ…æµ‹è¯•
- âœ… **è‡ªåŠ¨éªŒè¯** - è‡ªåŠ¨æ£€æŸ¥ CLI æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- âœ… **æ¸…æ™°çš„æ—¥å¿—** - æ˜¾ç¤ºä½¿ç”¨çš„ CLI è·¯å¾„å’Œæ¥æº

## ğŸ“ ä½¿ç”¨æ–¹å¼

### ä¼˜å…ˆçº§è§„åˆ™

CLI è·¯å¾„çš„ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. **å‘½ä»¤è¡Œå‚æ•°** `--cli`
2. **é»˜è®¤è·¯å¾„** `./dist/cli.js`

---

## ğŸ”§ åœºæ™¯ 1ï¼šå¼€å‘é˜¶æ®µæµ‹è¯•ï¼ˆé»˜è®¤ï¼‰

**åœºæ™¯ï¼š** æµ‹è¯•é¡¹ç›®å†… `dist/` ç›®å½•çš„æ„å»ºç»“æœ

```bash
# æ„å»ºé¡¹ç›®
npm run build

# è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰
npm run test:e2e
```

**è¯´æ˜ï¼š**

- ä½¿ç”¨é»˜è®¤è·¯å¾„ `./dist/cli.js`
- é€‚åˆæ—¥å¸¸å¼€å‘æµ‹è¯•

---

## ğŸ”§ åœºæ™¯ 2ï¼šæŒ‡å®š CLI è·¯å¾„ï¼ˆå‘½ä»¤è¡Œå‚æ•°ï¼‰â­ æ¨è

**åœºæ™¯ï¼š** æ˜ç¡®æŒ‡å®šè¦æµ‹è¯•çš„ CLI æ–‡ä»¶è·¯å¾„

```bash
# æ–¹å¼ 1: æµ‹è¯•ç‰¹å®šè·¯å¾„çš„ CLI
npm run test:e2e -- --cli ./dist/cli.js

# æ–¹å¼ 2: æµ‹è¯•å…¶ä»–ç›®å½•çš„ CLI
npm run test:e2e -- --cli /path/to/other/cli.js

# æ–¹å¼ 3: åªæµ‹è¯•ç‰¹å®šéƒ¨åˆ†ï¼ˆä½¿ç”¨ Jest å‚æ•°ï¼‰
npm run test:e2e -- --cli ./dist/cli.js --testPathPattern=cli
npm run test:e2e -- --cli ./dist/cli.js --testPathPattern=mcp
```

**è¯´æ˜ï¼š**

- `--cli` å‚æ•°ä¼˜å…ˆçº§æœ€é«˜
- æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
- ç›¸å¯¹è·¯å¾„ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºç»å¯¹è·¯å¾„

---

## ğŸ“¦ åœºæ™¯ 3ï¼šæµ‹è¯•æœ¬åœ°æ‰“åŒ…çš„å‘å¸ƒåŒ…

**åœºæ™¯ï¼š** æµ‹è¯• `npm pack` ç”Ÿæˆçš„ `.tgz` åŒ…

```bash
# 1. æ‰“åŒ…
npm pack
# ç”Ÿæˆ cocos-cli-1.0.0.tgz

# 2. åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å®‰è£…
mkdir /tmp/test-cocos
cd /tmp/test-cocos
npm install /path/to/cocos-cli-1.0.0.tgz

# 3. è¿è¡Œæµ‹è¯•ï¼ˆæŒ‡å®šå®‰è£…åçš„ CLI è·¯å¾„ï¼‰
cd /path/to/cocos-cli
npm run test:e2e -- --cli /tmp/test-cocos/node_modules/.bin/cocos

# 4. æ¸…ç†
rm -rf /tmp/test-cocos
```

**è¯´æ˜ï¼š**

- æ‰‹åŠ¨æ‰“åŒ…ã€å®‰è£…ã€æµ‹è¯•ã€æ¸…ç†
- å¯ä»¥åœ¨å¤–éƒ¨è„šæœ¬ä¸­è‡ªåŠ¨åŒ–è¿™äº›æ­¥éª¤

---

## ğŸŒ åœºæ™¯ 4ï¼šæµ‹è¯•å…¨å±€å®‰è£…çš„å‘å¸ƒåŒ…

**åœºæ™¯ï¼š** æµ‹è¯•é€šè¿‡ `npm install -g` å®‰è£…çš„åŒ…

```bash
# 1. å®‰è£…æœ¬åœ°æ‰“åŒ…çš„åŒ…
npm pack
npm install -g ./cocos-cli-1.0.0.tgz

# 2. è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨å…¨å±€å®‰è£…çš„ CLIï¼‰
npm run test:e2e -- --cli $(which cocos)

# æˆ–è€…åªè¿è¡Œéƒ¨åˆ†æµ‹è¯•
npm run test:e2e -- --cli $(which cocos) --testPathPattern=cli

# Windows PowerShell
npm run test:e2e -- --cli (Get-Command cocos).Source
```

**è¯´æ˜ï¼š**

- `which cocos` (Linux/Mac) æˆ– `Get-Command cocos` (Windows) è·å–å…¨å±€ CLI è·¯å¾„
- é€‚åˆæµ‹è¯•å‘å¸ƒå‰çš„æœ€ç»ˆéªŒè¯

---

## ğŸš€ åœºæ™¯ 5ï¼šæµ‹è¯•å·²å‘å¸ƒçš„ npm åŒ…

**åœºæ™¯ï¼š** æµ‹è¯•ä» npm registry å®‰è£…çš„æ­£å¼ç‰ˆæœ¬

```bash
# 1. å®‰è£…æœ€æ–°ç‰ˆæœ¬
npm install -g cocos-cli@latest

# 2. è¿è¡Œæµ‹è¯•
npm run test:e2e -- --cli $(which cocos)

# æˆ–è€…æŒ‡å®šç‰¹å®šç‰ˆæœ¬
npm install -g cocos-cli@1.2.3
npm run test:e2e -- --cli $(which cocos)
```

**è¯´æ˜ï¼š**

- ç”¨äºéªŒè¯çº¿ä¸Šç‰ˆæœ¬æ˜¯å¦æ­£å¸¸
- å¯ä»¥åœ¨ç”¨æˆ·æŠ¥å‘Šé—®é¢˜åå¿«é€ŸéªŒè¯

---

## âš¡ åœºæ™¯ 6ï¼šå¿«é€ŸéªŒè¯

**åœºæ™¯ï¼š** åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼Œé€Ÿåº¦æ›´å¿«

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•ï¼ˆæ›´å¿«ï¼‰
npm run test:e2e -- --cli ./dist/cli.js -t "should query project info"

# åªæµ‹è¯•ç‰¹å®šæ¨¡å—
npm run test:e2e -- --testPathPattern=mcp/api/project

# åªæµ‹è¯• CLI å‘½ä»¤
npm run test:e2e -- --testPathPattern=cli
```

**è¯´æ˜ï¼š**

- ä½¿ç”¨ Jest çš„ `-t` å‚æ•°å¯ä»¥åªè¿è¡Œç‰¹å®šæµ‹è¯•
- ä½¿ç”¨ `--testPathPattern` å¯ä»¥åªè¿è¡Œç‰¹å®šæ–‡ä»¶çš„æµ‹è¯•
- é€‚åˆå¿«é€ŸéªŒè¯æˆ– CI/CD ä¸­ä½¿ç”¨

---

## ğŸ” æŸ¥çœ‹æµ‹è¯•é…ç½®

æµ‹è¯•å¼€å§‹æ—¶ä¼šæ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼š

```
============================================================
ğŸš€ E2E æµ‹è¯•ç¯å¢ƒå‡†å¤‡ä¸­...
============================================================

ğŸ“‹ CLI è·¯å¾„æ¥æº: command line argument
   å‚æ•°å€¼: ./dist/cli.js
ğŸ“ æœ€ç»ˆ CLI è·¯å¾„: /path/to/cocos-cli/dist/cli.js

âœ… CLI æ–‡ä»¶éªŒè¯é€šè¿‡
ğŸ“¦ æµ‹è¯•æ¨¡å¼: Full Tests (å®Œæ•´æµ‹è¯•)

============================================================
ğŸ¯ å¼€å§‹æ‰§è¡Œ E2E æµ‹è¯•...
============================================================
```

---

## ğŸ› ï¸ CI/CD é›†æˆç¤ºä¾‹

### GitHub Actions

```yaml
# .github/workflows/test.yml
name: E2E Tests

on: [push, pull_request]

jobs:
  test-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - run: npm run test:e2e
```

### GitLab CI

```yaml
# .gitlab-ci.yml
test-e2e:
  script:
    - npm install
    - npm run build
    - npm run test:e2e
```

---

## ğŸ“Š æµ‹è¯•è„šæœ¬å¯¹ç…§è¡¨

| è„šæœ¬å‘½ä»¤ | è¯´æ˜ | CLI è·¯å¾„ | æµ‹è¯•èŒƒå›´ |
|---------|------|---------|---------|
| `npm run test:e2e` | å®Œæ•´ E2E æµ‹è¯• | é»˜è®¤ dist/ | å…¨éƒ¨ |
| `npm run test:e2e:debug` | è°ƒè¯•æ¨¡å¼ï¼ˆä¿ç•™å·¥ä½œåŒºï¼‰ | é»˜è®¤ dist/ | å…¨éƒ¨ |
| `npm run test:all` | æ‰€æœ‰æµ‹è¯•ï¼ˆå•å…ƒ+E2Eï¼‰ | é»˜è®¤ dist/ | å…¨éƒ¨ |

### Jest å‚æ•°ç”¨æ³•

```bash
# åªæµ‹è¯• CLI éƒ¨åˆ†
npm run test:e2e -- --testPathPattern=cli

# åªæµ‹è¯• MCP éƒ¨åˆ†
npm run test:e2e -- --testPathPattern=mcp

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
npm run test:e2e -- -t "should build"
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•çŸ¥é“æµ‹è¯•ä½¿ç”¨çš„æ˜¯å“ªä¸ª CLIï¼Ÿ

**A:** æµ‹è¯•å¼€å§‹æ—¶ä¼šæ‰“å° CLI è·¯å¾„å’Œæ¥æºï¼š

```
ğŸ“‹ CLI è·¯å¾„æ¥æº: command line argument
ğŸ“ æœ€ç»ˆ CLI è·¯å¾„: /path/to/cli.js
```

### Q2: ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:**

- ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `./dist/cli.js`ï¼‰ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
- ç»å¯¹è·¯å¾„ï¼ˆå¦‚ `/usr/local/bin/cocos`ï¼‰ç›´æ¥ä½¿ç”¨
- å»ºè®®ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæ›´çµæ´»

### Q3: æµ‹è¯•å¤±è´¥åä¸´æ—¶æ–‡ä»¶ä¼šæ¸…ç†å—ï¼Ÿ

**A:**

- E2E æµ‹è¯•ä¼šè‡ªåŠ¨æ¸…ç†å·¥ä½œåŒºï¼ˆ`e2e/.workspace/`ï¼‰
- æ‰‹åŠ¨æµ‹è¯•éœ€è¦æ‰‹åŠ¨æ¸…ç†ä¸´æ—¶ç›®å½•

### Q4: å¦‚ä½•åœ¨ Windows ä¸Šè·å–å…¨å±€ CLI è·¯å¾„ï¼Ÿ

**A:**

```powershell
# PowerShell
npm run test:e2e -- --cli (Get-Command cocos).Source

# CMDï¼ˆéœ€è¦å…ˆæŸ¥æ‰¾è·¯å¾„ï¼‰
where cocos
npm run test:e2e -- --cli C:\Users\...\cocos
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨é»˜è®¤è·¯å¾„

   ```bash
   npm run test:e2e
   ```

2. **å‘å¸ƒå‰éªŒè¯**ï¼šæµ‹è¯•æ‰“åŒ…åçš„åŒ…

   ```bash
   # æ‰“åŒ…å¹¶æ‰‹åŠ¨æµ‹è¯•
   npm pack
   npm run test:e2e -- --cli /path/to/installed/cocos
   ```

3. **CI/CD**ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•

   ```yaml
   - run: npm run test:e2e
   ```

4. **é—®é¢˜æ’æŸ¥**ï¼šæŒ‡å®šå…·ä½“è·¯å¾„

   ```bash
   npm run test:e2e -- --cli /specific/path
   ```

### âŒ é¿å…åšæ³•

1. ä¸è¦ç¡¬ç¼–ç ç»å¯¹è·¯å¾„
2. ä¸è¦åœ¨æµ‹è¯•ä¸­ä¿®æ”¹å…¨å±€ç¯å¢ƒ
3. ä¸è¦è·³è¿‡ CLI è·¯å¾„éªŒè¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [E2E æµ‹è¯•æ€»è§ˆ](./README.md)
- [E2E æµ‹è¯•ä½¿ç”¨æŒ‡å—](./USAGE.md)
- [æµ‹è¯•è¾…åŠ©å·¥å…·](./helpers/README.md)

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** è¯·æŸ¥çœ‹ [USAGE.md](./USAGE.md) æˆ–æäº¤ Issueã€‚
