# E2E æµ‹è¯•å·¥ä½œæµ
#
# è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 2. å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 00:00ï¼ˆUTC 16:00ï¼‰
# 3. è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "run e2e test"
#
# åŠŸèƒ½ï¼š
# - è¿è¡Œå®Œæ•´çš„ E2E æµ‹è¯•å¥—ä»¶
# - ç”Ÿæˆå¯è§†åŒ–çš„ HTML æµ‹è¯•æŠ¥å‘Š
# - åœ¨ PR ä¸­è‡ªåŠ¨è¯„è®ºæµ‹è¯•ç»“æœå’ŒæŠ¥å‘Šé“¾æ¥
# - ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šä¸º GitHub Artifactsï¼ˆä¿ç•™ 30 å¤©ï¼‰

name: E2E Tests

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨ 12 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ = UTC+8ï¼Œæ‰€ä»¥ UTC æ—¶é—´æ˜¯ 16:00ï¼‰
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤© UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00
  
  # è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "run e2e test"
  issue_comment:
    types: [created]

env:
  # é…ç½®æµ‹è¯•æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€
  REPORT_SERVER_URL: 'http://your-server.com/e2e-reports'

jobs:
  e2e-tests:
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
    # 2. å®šæ—¶è§¦å‘ (schedule)
    # 3. è¯„è®ºåŒ…å« "run e2e test"
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'run e2e test'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œéœ€è¦æ£€å‡º PR çš„ä»£ç 
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true
      
      - name: Find test report file
        if: always()
        id: find-report
        run: |
          # æŸ¥æ‰¾æœ€æ–°ç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶
          REPORT_FILE=$(ls -t e2e/reports/test-report-*.html 2>/dev/null | head -n 1)
          
          if [ -n "$REPORT_FILE" ]; then
            echo "Found report: $REPORT_FILE"
            REPORT_FILENAME=$(basename "$REPORT_FILE")
            echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
            echo "report_filename=$REPORT_FILENAME" >> $GITHUB_OUTPUT
            echo "report_exists=true" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆå®Œæ•´çš„æŠ¥å‘Š URL
            REPORT_URL="${{ env.REPORT_SERVER_URL }}/reports/$REPORT_FILENAME"
            echo "report_url=$REPORT_URL" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Test Report: $REPORT_URL"
          else
            echo "No report file found"
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload test report to server
        if: always() && steps.find-report.outputs.report_exists == 'true'
        run: |
          echo "ğŸ“¤ Uploading test report to server..."
          echo "Report file: ${{ steps.find-report.outputs.report_file }}"
          echo "Report URL: ${{ steps.find-report.outputs.report_url }}"
          
          # è¿™é‡Œæ·»åŠ ä½ ä¸Šä¼ æŠ¥å‘Šåˆ°æœåŠ¡å™¨çš„å‘½ä»¤
          # ä¾‹å¦‚ä½¿ç”¨ scp, rsync, curl ç­‰
          # scp ${{ steps.find-report.outputs.report_file }} user@server:/path/to/reports/
          # æˆ–è€…
          # curl -F "file=@${{ steps.find-report.outputs.report_file }}" ${{ env.REPORT_SERVER_URL }}/upload
          
          echo "âœ… Report uploaded successfully"
      
      - name: Upload test report as artifact (å¤‡ç”¨)
        if: always() && steps.find-report.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report-${{ github.run_id }}
          path: ${{ steps.find-report.outputs.report_file }}
          retention-days: 30
      
      - name: Comment PR with test report link
        if: always() && (github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request))
        uses: actions/github-script@v7
        env:
          REPORT_EXISTS: ${{ steps.find-report.outputs.report_exists }}
          REPORT_URL: ${{ steps.find-report.outputs.report_url }}
          REPORT_FILENAME: ${{ steps.find-report.outputs.report_filename }}
        with:
          script: |
            const reportExists = process.env.REPORT_EXISTS === 'true';
            const reportUrl = process.env.REPORT_URL;
            const reportFilename = process.env.REPORT_FILENAME;
            
            let comment = `## ğŸ“Š E2E æµ‹è¯•æŠ¥å‘Š\n\n`;
            
            if (reportExists) {
              comment += `âœ… æµ‹è¯•å·²å®Œæˆï¼\n\n`;
              comment += `### ğŸ”— åœ¨çº¿æŸ¥çœ‹æŠ¥å‘Š\n\n`;
              comment += `**æŠ¥å‘Šåœ°å€**: [${reportFilename}](${reportUrl})\n\n`;
              comment += `> ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹é“¾æ¥å³å¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å®Œæ•´çš„æµ‹è¯•æŠ¥å‘Š\n\n`;
              comment += `---\n\n`;
              comment += `### ğŸ“‹ æŠ¥å‘Šå†…å®¹\n\n`;
              comment += `æŠ¥å‘ŠåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\n`;
              comment += `- âœ… æµ‹è¯•é€šè¿‡/å¤±è´¥ç»Ÿè®¡\n`;
              comment += `- â±ï¸ æ¯ä¸ªæµ‹è¯•çš„æ‰§è¡Œæ—¶é—´\n`;
              comment += `- ğŸ“ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª\n`;
              comment += `- ğŸ’¬ æ§åˆ¶å°æ—¥å¿—è¾“å‡º\n`;
              comment += `- ğŸ“Š å¯è§†åŒ–çš„æµ‹è¯•ç»“æœ\n\n`;
              comment += `---\n\n`;
              comment += `### ğŸ’¾ å¤‡ç”¨ä¸‹è½½\n\n`;
              comment += `å¦‚æœåœ¨çº¿æŸ¥çœ‹å¤±è´¥ï¼Œå¯ä»¥ä» GitHub Artifacts ä¸‹è½½æŠ¥å‘Šï¼š\n`;
              comment += `1. ç‚¹å‡»ä¸‹æ–¹çš„ "Artifacts" éƒ¨åˆ†\n`;
              comment += `2. ä¸‹è½½ \`e2e-test-report-${context.runId}\`\n`;
              comment += `3. è§£å‹ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ HTML æ–‡ä»¶\n`;
            } else {
              comment += `âŒ æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå¤±è´¥\n\n`;
              comment += `è¯·æ£€æŸ¥æµ‹è¯•æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚\n`;
            }
            
            comment += `\n---\n\n`;
            comment += `### ğŸ”§ æœ¬åœ°æŸ¥çœ‹æŠ¥å‘Š\n\n`;
            comment += `\`\`\`bash\n`;
            comment += `# è¿è¡Œæµ‹è¯•\n`;
            comment += `npm run test:e2e\n\n`;
            comment += `# æŸ¥çœ‹æŠ¥å‘Šï¼ˆä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼‰\n`;
            comment += `# Windows\n`;
            comment += `start e2e/reports/test-report-*.html\n\n`;
            comment += `# macOS\n`;
            comment += `open e2e/reports/test-report-*.html\n\n`;
            comment += `# Linux\n`;
            comment += `xdg-open e2e/reports/test-report-*.html\n`;
            comment += `\`\`\`\n\n`;
            comment += `---\n\n`;
            comment += `<sub>ğŸ¤– æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | Run ID: ${context.runId}</sub>\n`;
            
            // è·å– issue/PR ç¼–å·
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            
            // æŸ¥æ‰¾å·²æœ‰çš„æµ‹è¯•æŠ¥å‘Šè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('E2E æµ‹è¯•æŠ¥å‘Š')
            );
            
            if (botComment) {
              // æ›´æ–°å·²æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

