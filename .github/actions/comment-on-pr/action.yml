name: 'Comment on PR'
description: 'Âú® PR Êàñ Issue ‰∏äÂèëÂ∏ÉËØÑËÆ∫ÔºåÊîØÊåÅÊõ¥Êñ∞Â∑≤ÊúâËØÑËÆ∫'

inputs:
  pat-token:
    description: 'GitHub Personal Access Token'
    required: true
  message:
    description: 'Ë¶ÅÂèëÂ∏ÉÁöÑËØÑËÆ∫ÂÜÖÂÆπ'
    required: true
  update-if-exists:
    description: 'Â¶ÇÊûúÂ∑≤ÊúâËØÑËÆ∫ÂàôÊõ¥Êñ∞ÔºàÈªòËÆ§ falseÔºâ'
    required: false
    default: 'false'
  comment-identifier:
    description: 'Áî®‰∫éËØÜÂà´Â∑≤ÊúâËØÑËÆ∫ÁöÑÊ†áËØÜÊñáÊú¨ÔºàÁî®‰∫éÊõ¥Êñ∞Êó∂Êü•ÊâæËØÑËÆ∫Ôºâ'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Comment on PR or Issue
      if: ${{ inputs.pat-token != '' && (github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)) }}
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.pat-token }}
        script: |
          const comment = process.env.MESSAGE_CONTENT;
          const shouldUpdate = '${{ inputs.update-if-exists }}' === 'true';
          const identifier = '${{ inputs.comment-identifier }}';
          
          // Ëé∑Âèñ issue/PR ÁºñÂè∑
          const issueNumber = context.issue?.number || context.payload.issue?.number;
          
          if (!issueNumber) {
            console.log('‚ö†Ô∏è Could not determine issue/PR number');
            return;
          }
          
          console.log(`üìù Commenting on #${issueNumber}`);
          
          try {
            if (shouldUpdate) {
              // Êü•ÊâæÂ∑≤ÊúâÁöÑËØÑËÆ∫Âπ∂Êõ¥Êñ∞
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              // ‰ºòÂÖà‰ΩøÁî® HTML Ê≥®ÈáäÊ†áËÆ∞Êü•ÊâæÔºàÊúÄÂèØÈù†Ôºâ
              let botComment = comments.find(c => 
                c.user.type === 'Bot' && 
                c.body.includes('<!-- PR_TEST_COMMENT -->')
              );
              
              // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ HTML Ê≥®ÈáäÊ†áËÆ∞ÔºåÂàô‰ΩøÁî® identifierÔºàÂêëÂêéÂÖºÂÆπÔºâ
              if (!botComment && identifier) {
                // ÊâæÂà∞ÊâÄÊúâÂåπÈÖçÁöÑËØÑËÆ∫ÔºåÈÄâÊã©ÊúÄÊó©ÂàõÂª∫ÁöÑÈÇ£‰∏™ÔºàÈÅøÂÖçÂ§ö‰∏™ËØÑËÆ∫Ôºâ
                const matchingComments = comments.filter(c => 
                  c.user.type === 'Bot' && 
                  c.body.includes(identifier)
                );
                
                if (matchingComments.length > 0) {
                  // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºåÈÄâÊã©ÊúÄÊó©ÁöÑÈÇ£‰∏™
                  matchingComments.sort((a, b) => 
                    new Date(a.created_at) - new Date(b.created_at)
                  );
                  botComment = matchingComments[0];
                  
                  // Â¶ÇÊûúÊâæÂà∞Â§ö‰∏™ÂåπÈÖçÁöÑËØÑËÆ∫ÔºåËÆ∞ÂΩïË≠¶Âëä
                  if (matchingComments.length > 1) {
                    console.log(`‚ö†Ô∏è Found ${matchingComments.length} matching comments, updating the earliest one (ID: ${botComment.id})`);
                  }
                }
              }
              
              if (botComment) {
                // Êõ¥Êñ∞Â∑≤ÊúâËØÑËÆ∫
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log(`‚úÖ Comment updated (ID: ${botComment.id})`);
                return;
              }
            }
            
            // ÂàõÂª∫Êñ∞ËØÑËÆ∫
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            console.log(`‚úÖ Comment created on #${issueNumber}`);
          } catch (error) {
            console.error('‚ùå Failed to comment:', error.message);
            if (error.status) {
              console.error(`   Status: ${error.status}`);
            }
            if (error.response?.data) {
              console.error(`   Details: ${JSON.stringify(error.response.data, null, 2)}`);
            }
            throw error;
          }
      env:
        MESSAGE_CONTENT: ${{ inputs.message }}

